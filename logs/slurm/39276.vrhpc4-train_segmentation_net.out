2025-07-27 18:43:48 INFO Starting training with configuration: {'model': {'name': 'unet', 'alias': 'unet_densenet121', 'encoder_name': 'densenet121', 'encoder_weights': 'imagenet', 'in_channels': 1, 'classes': 1, 'activation': 'sigmoid', 'dropout': 0.2}, 'dataset': {'root': '/data/smadper@alumno.upv.es/TFM/datasets/laticifers', 'patch_size': [512, 512], 'stride': [256, 256], 'num_patches': 20, 'dataset_csv': 'laticifer_dataset_index.csv', 'num_workers': 4, 'positive_ratio': 0.8, 'fg_threshold': 0.04, 'dist_transform': True, 'feature_dirs': {'enhanced': '/data/smadper@alumno.upv.es/TFM/datasets/laticifers/enhanced_images', 'mask': '/data/smadper@alumno.upv.es/TFM/datasets/laticifers/masks', 'distance': '/data/smadper@alumno.upv.es/TFM/datasets/laticifers/distance_maps_pt'}}, 'train': {'batch_size': 16, 'num_epochs': 70, 'learning_rate': 0.001, 'accumulation_steps': 1, 'save_dir': '/data/smadper@alumno.upv.es/TFM/checkpoints2/unet/20250727_184348_bce_dice_20patches', 'log_interval': 1, 'patience': 10, 'mixed_precision': True, 'experiment_name': 'bce_dice_20patches', 'timestamp': '20250727_184348'}, 'test': {'batch_size': 1}, 'loss': {'name': 'bce', 'cldice_alpha': 0.3, 'use_topographic': False, 'combine_with': 'dice', 'weights': {'main': 0.5, 'combined': 0.5}, 'topo': {'alpha': 2.0, 'beta': 1.0}}}
2025-07-27 18:43:48 INFO Experiment name: bce_dice_20patches
2025-07-27 18:43:48 INFO Loading model unet with settings {'name': 'unet', 'alias': 'unet_densenet121', 'encoder_name': 'densenet121', 'encoder_weights': 'imagenet', 'in_channels': 1, 'classes': 1, 'activation': 'sigmoid', 'dropout': 0.2}
preds: (tensor([[[[0.4769, 0.4533, 0.5908,  ..., 0.3570, 0.5025, 0.4937],
          [0.4828, 0.5469, 0.5322,  ..., 0.5228, 0.5275, 0.5393],
          [0.3780, 0.6472, 0.6018,  ..., 0.3710, 0.4784, 0.5697],
          ...,
          [0.3841, 0.4926, 0.5731,  ..., 0.3451, 0.4804, 0.6313],
          [0.3283, 0.5121, 0.5461,  ..., 0.3939, 0.5332, 0.5721],
          [0.3887, 0.5031, 0.5437,  ..., 0.5246, 0.5720, 0.5889]]],


        [[[0.3851, 0.3476, 0.5042,  ..., 0.3086, 0.4475, 0.5489],
          [0.4504, 0.5040, 0.5517,  ..., 0.4113, 0.6056, 0.6040],
          [0.4073, 0.4376, 0.5043,  ..., 0.3079, 0.5312, 0.5788],
          ...,
          [0.3718, 0.5657, 0.5626,  ..., 0.4908, 0.4111, 0.6437],
          [0.3703, 0.6017, 0.4930,  ..., 0.5669, 0.5267, 0.5383],
          [0.3893, 0.5601, 0.5390,  ..., 0.3339, 0.4657, 0.4228]]],


        [[[0.3743, 0.2311, 0.3123,  ..., 0.3474, 0.4149, 0.5365],
          [0.5031, 0.4843, 0.3492,  ..., 0.3172, 0.5544, 0.6578],
          [0.4721, 0.4755, 0.4558,  ..., 0.2436, 0.4464, 0.6580],
          ...,
          [0.2679, 0.5307, 0.4926,  ..., 0.5592, 0.5855, 0.6027],
          [0.3052, 0.4606, 0.4939,  ..., 0.5545, 0.5769, 0.6096],
          [0.3982, 0.4978, 0.4000,  ..., 0.4305, 0.4819, 0.4401]]],


        ...,


        [[[0.3461, 0.2784, 0.4455,  ..., 0.3428, 0.4387, 0.4965],
          [0.4537, 0.5827, 0.5536,  ..., 0.4982, 0.6883, 0.6448],
          [0.4084, 0.4367, 0.2994,  ..., 0.3736, 0.4939, 0.6163],
          ...,
          [0.3760, 0.4505, 0.4862,  ..., 0.3653, 0.4883, 0.7704],
          [0.3360, 0.5566, 0.5966,  ..., 0.4203, 0.4101, 0.6052],
          [0.4179, 0.5701, 0.6210,  ..., 0.3484, 0.4615, 0.4523]]],


        [[[0.3658, 0.4518, 0.5582,  ..., 0.3214, 0.4458, 0.6353],
          [0.4570, 0.6108, 0.6496,  ..., 0.4520, 0.6400, 0.7046],
          [0.4543, 0.6961, 0.5561,  ..., 0.2574, 0.6196, 0.6154],
          ...,
          [0.3699, 0.4212, 0.4231,  ..., 0.5458, 0.4802, 0.7656],
          [0.4219, 0.4989, 0.5382,  ..., 0.5866, 0.5720, 0.6638],
          [0.4268, 0.4465, 0.4349,  ..., 0.4366, 0.5319, 0.5184]]],


        [[[0.4478, 0.3440, 0.4372,  ..., 0.3647, 0.4514, 0.5551],
          [0.4930, 0.4062, 0.4296,  ..., 0.4197, 0.5301, 0.5526],
          [0.4784, 0.5219, 0.4269,  ..., 0.3205, 0.5396, 0.6739],
          ...,
          [0.3995, 0.4090, 0.5578,  ..., 0.5197, 0.4836, 0.5595],
          [0.3820, 0.4766, 0.4470,  ..., 0.5378, 0.4850, 0.5345],
          [0.4264, 0.4939, 0.5594,  ..., 0.4458, 0.4612, 0.3974]]]],
       device='cuda:0', grad_fn=<SigmoidBackward0>), tensor([[ 0.6372],
        [ 0.9877],
        [-0.1055],
        [ 1.0906],
        [ 0.5313],
        [ 0.9470],
        [ 0.5017],
        [ 0.4553],
        [ 0.6486],
        [-0.2457],
        [-0.1268],
        [ 0.3780],
        [ 0.0091],
        [ 0.8403],
        [ 0.6166],
        [ 1.6463]], device='cuda:0', grad_fn=<AddmmBackward0>))
len preds: 2
aaa: 16, 16
Traceback (most recent call last):
  File "/data/smadper@alumno.upv.es/TFM/src/train.py", line 214, in <module>
    main(conf)
  File "/data/smadper@alumno.upv.es/TFM/src/train.py", line 181, in main
    best_model_path, best_dice, best_cldice, best_val_loss, best_epoch = train_model(model, train_loader, test_loader, conf)
                                                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/data/smadper@alumno.upv.es/TFM/src/train.py", line 129, in train_model
    loss = loss_fn(model(images), masks) / accumulation_steps
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/data/smadper@alumno.upv.es/TFM/src/utils.py", line 120, in fn
    main = loss_map[name](preds, targets)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/data/smadper@alumno.upv.es/TFM/src/utils.py", line 110, in <lambda>
    'bce': lambda p,t: F.binary_cross_entropy(p,t),
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/data/smadper@alumno.upv.es/miniconda3/envs/tfm/lib/python3.12/site-packages/torch/nn/functional.py", line 3559, in binary_cross_entropy
    if target.size() != input.size():
                        ^^^^^^^^^^
AttributeError: 'tuple' object has no attribute 'size'
